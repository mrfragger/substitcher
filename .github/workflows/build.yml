name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
      runs-on: macos-latest
      steps:
        - uses: actions/checkout@v4
        
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
        
        - name: Build macOS
          run: |
            flutter pub get
            flutter build macos --release
            
            codesign --force --deep --sign - \
              --entitlements macos/Runner/Release.entitlements \
              build/macos/Build/Products/Release/substitcher.app
        
        - name: Create DMG
          run: |
            brew install create-dmg
            create-dmg \
              --volname "SubStitcher" \
              --window-pos 200 120 \
              --window-size 600 300 \
              --icon-size 100 \
              --app-drop-link 425 120 \
              "SubStitcher-macOS.dmg" \
              "build/macos/Build/Products/Release/substitcher.app"
        
        - name: Upload macOS artifact
          uses: actions/upload-artifact@v4
          with:
            name: macos-build
            path: SubStitcher-macOS.dmg

  build-linux:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
        
        - name: Install dependencies
          run: |
            sudo apt-get update
            sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libmpv-dev mpv nasm yasm
        
        - name: Build minimal LGPL FFmpeg
          run: |
            wget https://ffmpeg.org/releases/ffmpeg-8.0.1.tar.xz
            tar xf ffmpeg-8.0.1.tar.xz
            cd ffmpeg-8.0.1
            
            ./configure \
              --prefix=$PWD/../ffmpeg-install \
              --disable-shared \
              --enable-static \
              --disable-gpl \
              --disable-nonfree \
              --disable-doc \
              --disable-debug \
              --disable-everything \
              --disable-xlib \
              --disable-libxcb \
              --disable-libxcb-shm \
              --disable-libxcb-xfixes \
              --disable-libxcb-shape \
              --disable-autodetect \
              --enable-ffmpeg \
              --enable-ffprobe \
              --enable-decoder=opus,aac,aac_fixed,aac_latm,mp3,mp3float,pcm_s16le,pcm_s24le,pcm_f32le,flac,vorbis,alac \
              --enable-encoder=opus,aac,pcm_s16le \
              --enable-demuxer=opus,ogg,matroska,wav,mp3,aac,m4a,mov,flac \
              --enable-muxer=opus,ogg,matroska,wav,ipod,mp4 \
              --enable-parser=opus,aac,aac_latm,mp3,flac,vorbis \
              --enable-protocol=file \
              --enable-filter=volume,equalizer,highpass,lowpass,aformat,aresample,atempo
            
            make -j$(nproc)
            make install
            
            strip --strip-all ../ffmpeg-install/bin/ffmpeg
            strip --strip-all ../ffmpeg-install/bin/ffprobe
            
            mkdir -p ../bin
            cp ../ffmpeg-install/bin/ffmpeg ../bin/
            cp ../ffmpeg-install/bin/ffprobe ../bin/
            chmod +x ../bin/ffmpeg
            chmod +x ../bin/ffprobe
            
            echo "Binary sizes:"
            ls -lh ../bin/
            
            echo "Checking dynamic dependencies:"
            ldd ../bin/ffmpeg
        
        - name: Build Linux
          run: |
            flutter pub get
            flutter build linux --release
            
            cp bin/ffmpeg build/linux/x64/release/bundle/
            cp bin/ffprobe build/linux/x64/release/bundle/
        
        - name: Create AppImage
          run: |
            chmod +x build_appimage.sh
            ./build_appimage.sh
        
        - name: Upload Linux artifact
          uses: actions/upload-artifact@v4
          with:
            name: linux-build
            path: substitcher-*.AppImage

  build-windows:
        runs-on: windows-latest
        steps:
          - uses: actions/checkout@v4
          
          - uses: subosito/flutter-action@v2
            with:
              channel: 'stable'
          
          - name: Setup MSYS2
            uses: msys2/setup-msys2@v2
            with:
              msystem: MINGW64
              update: true
              install: >-
                base-devel
                mingw-w64-x86_64-toolchain
                mingw-w64-x86_64-cmake
                mingw-w64-x86_64-nasm
                mingw-w64-x86_64-yasm
          
          - name: Download and build FFmpeg
            shell: msys2 {0}
            run: |
              curl -L https://ffmpeg.org/releases/ffmpeg-8.0.1.tar.xz -o ffmpeg.tar.xz
              tar xf ffmpeg.tar.xz
              cd ffmpeg-8.0.1
              
              ./configure \
                --prefix=/d/a/substitcher/substitcher/ffmpeg-install \
                --disable-shared \
                --enable-static \
                --disable-gpl \
                --disable-nonfree \
                --disable-doc \
                --disable-debug \
                --disable-everything \
                --enable-ffmpeg \
                --enable-ffprobe \
                --enable-decoder=opus,aac,aac_fixed,aac_latm,mp3,mp3float,pcm_s16le,pcm_s24le,pcm_f32le,flac,vorbis,alac \
                --enable-encoder=opus,aac,pcm_s16le \
                --enable-demuxer=opus,ogg,matroska,wav,mp3,aac,m4a,mov,flac \
                --enable-muxer=opus,ogg,matroska,wav,ipod,mp4 \
                --enable-parser=opus,aac,aac_latm,mp3,flac,vorbis \
                --enable-protocol=file \
                --enable-filter=volume,equalizer,highpass,lowpass,aformat,aresample,atempo
              
              make -j$(nproc)
              make install
              
              strip /d/a/substitcher/substitcher/ffmpeg-install/bin/ffmpeg.exe
              strip /d/a/substitcher/substitcher/ffmpeg-install/bin/ffprobe.exe
              
              echo "Binary sizes:"
              ls -lh /d/a/substitcher/substitcher/ffmpeg-install/bin/
          
          - name: Copy FFmpeg binaries
            shell: powershell
            run: |
              mkdir -Force windows\runner\Resources\bin
              Copy-Item "ffmpeg-install\bin\ffmpeg.exe" "windows\runner\Resources\bin\"
              Copy-Item "ffmpeg-install\bin\ffprobe.exe" "windows\runner\Resources\bin\"
          
          - name: Build Windows
            run: |
              flutter pub get
              flutter build windows --release
          
          - name: Copy FFmpeg to build output
            run: |
              mkdir -Force build\windows\x64\runner\Release\data\flutter_assets\bin
              Copy-Item "windows\runner\Resources\bin\ffmpeg.exe" "build\windows\x64\runner\Release\data\flutter_assets\bin\"
              Copy-Item "windows\runner\Resources\bin\ffprobe.exe" "build\windows\x64\runner\Release\data\flutter_assets\bin\"
          
          - name: Create ZIP
            run: |
              Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath SubStitcher-Windows.zip
          
          - name: Upload Windows artifact
            uses: actions/upload-artifact@v4
            with:
              name: windows-build
              path: SubStitcher-Windows.zip

  build-android:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        
        - uses: actions/setup-java@v4
          with:
            distribution: 'zulu'
            java-version: '17'
        
        - uses: subosito/flutter-action@v2
          with:
            channel: 'stable'
            cache: true
        
        - name: Build Android APK
          run: |
            flutter pub get
            flutter build apk --release
        
        - name: Rename APK
          run: |
            mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/substitcher-android-app.apk
        
        - name: Upload Android APK
          uses: actions/upload-artifact@v4
          with:
            name: android-build
            path: build/app/outputs/flutter-apk/substitcher-android-app.apk

  create-release:
      needs: [build-macos, build-linux, build-windows, build-android]
      runs-on: ubuntu-latest
      if: startsWith(github.ref, 'refs/tags/')
      steps:
        - name: Download all artifacts
          uses: actions/download-artifact@v4
        
        - name: Create Release
          uses: softprops/action-gh-release@v1
          with:
            files: |
              macos-build/SubStitcher-macOS.dmg
              linux-build/substitcher-*.AppImage
              windows-build/SubStitcher-Windows.zip
              android-build/substitcher-android-app.apk
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}