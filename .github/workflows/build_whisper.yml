name: Build Whisper Binaries

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build_whisper.yml'

jobs:
  build-whisper-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake
      
      - name: Clone and build whisper.cpp
        run: |
          git clone https://github.com/ggerganov/whisper.cpp.git
          cd whisper.cpp
          git checkout v1.8.2
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
          strip bin/whisper-cli
      
      - name: Create directory structure
        run: |
          mkdir -p whisper-binaries/linux
          cp whisper.cpp/build/bin/whisper-cli whisper-binaries/linux/
          chmod +x whisper-binaries/linux/whisper-cli
      
      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: whisper-linux
          path: whisper-binaries/linux/
  
  build-whisper-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Clone whisper.cpp
        run: |
          git clone https://github.com/ggerganov/whisper.cpp.git
          cd whisper.cpp
          git checkout v1.8.2
      
      - name: Build x86_64 (no optimizations)
        run: |
          cd whisper.cpp
          mkdir build-x86_64 && cd build-x86_64
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DGGML_NATIVE=OFF \
            -DWHISPER_METAL=OFF
          cmake --build . --config Release -j 4
      
      - name: Build arm64 (with Metal)
        run: |
          cd whisper.cpp
          mkdir build-arm64 && cd build-arm64
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DWHISPER_METAL=ON
          cmake --build . --config Release -j 4
      
      - name: Create universal binary
        run: |
          cd whisper.cpp
          lipo -create \
            build-x86_64/bin/whisper-cli \
            build-arm64/bin/whisper-cli \
            -output whisper-cli-universal
          strip whisper-cli-universal
      
      - name: Create directory structure
        run: |
          mkdir -p whisper-binaries/macos
          cp whisper.cpp/whisper-cli-universal whisper-binaries/macos/whisper-cli
          chmod +x whisper-binaries/macos/whisper-cli
      
      - name: Verify universal binary
        run: |
          file whisper-binaries/macos/whisper-cli
          lipo -info whisper-binaries/macos/whisper-cli
          ls -lh whisper-binaries/macos/whisper-cli
      
      - name: Upload macOS binary
        uses: actions/upload-artifact@v4
        with:
          name: whisper-macos
          path: whisper-binaries/macos/
  
  build-whisper-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Git
        run: |
          choco install git -y
        shell: powershell
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            git
      
      - name: Clone and build whisper.cpp
        shell: msys2 {0}
        run: |
          git clone https://github.com/ggerganov/whisper.cpp.git
          cd whisper.cpp
          git checkout v1.8.2
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -G "MinGW Makefiles"
          cmake --build . --config Release
          strip bin/whisper-cli.exe
      
      - name: Create directory structure
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path whisper-binaries/windows
          Copy-Item whisper.cpp/build/bin/whisper-cli.exe whisper-binaries/windows/
      
      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: whisper-windows
          path: whisper-binaries/windows/
  
  build-whisper-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
          add-to-path: true
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake
      
      - name: Clone whisper.cpp
        run: |
          git clone https://github.com/ggerganov/whisper.cpp.git
          cd whisper.cpp
          git checkout v1.8.2
      
      - name: Build for arm64-v8a
        run: |
          cd whisper.cpp
          mkdir build-arm64 && cd build-arm64
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_BUILD_TYPE=Release \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_EXAMPLES=ON
          cmake --build . --config Release
          $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip bin/whisper-cli
      
      - name: Build for armeabi-v7a
        run: |
          cd whisper.cpp
          mkdir build-armv7 && cd build-armv7
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=armeabi-v7a \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_BUILD_TYPE=Release \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_EXAMPLES=ON
          cmake --build . --config Release
          $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip bin/whisper-cli
      
      - name: Create directory structure
        run: |
          mkdir -p whisper-binaries/android/arm64-v8a
          mkdir -p whisper-binaries/android/armeabi-v7a
          cp whisper.cpp/build-arm64/bin/whisper-cli whisper-binaries/android/arm64-v8a/
          cp whisper.cpp/build-armv7/bin/whisper-cli whisper-binaries/android/armeabi-v7a/
          chmod +x whisper-binaries/android/arm64-v8a/whisper-cli
          chmod +x whisper-binaries/android/armeabi-v7a/whisper-cli
      
      - name: Upload Android binaries
        uses: actions/upload-artifact@v4
        with:
          name: whisper-android
          path: whisper-binaries/android/
  
  combine-artifacts:
    needs: [build-whisper-linux, build-whisper-macos, build-whisper-windows, build-whisper-android]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Combine all binaries
        run: |
          mkdir -p combined/linux
          mkdir -p combined/macos
          mkdir -p combined/windows
          mkdir -p combined/android/arm64-v8a
          mkdir -p combined/android/armeabi-v7a
          
          cp artifacts/whisper-linux/whisper-cli combined/linux/ || true
          cp artifacts/whisper-macos/whisper-cli combined/macos/ || true
          cp artifacts/whisper-windows/whisper-cli.exe combined/windows/ || true
          cp artifacts/whisper-android/arm64-v8a/whisper-cli combined/android/arm64-v8a/ || true
          cp artifacts/whisper-android/armeabi-v7a/whisper-cli combined/android/armeabi-v7a/ || true
          
          echo "=== Binary sizes ==="
          find combined -type f -exec ls -lh {} \;
      
      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: whisper-all-platforms
          path: combined/
          retention-days: 90
      
      - name: Create release with binaries
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: assets/whisper/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
